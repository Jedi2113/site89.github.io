<nav id="main-nav">
  <!-- Left side: logo + links -->
  <div class="nav-left">
    <a href="/" class="nav-logo">
      <img src="/assets/img/logowhite.png" alt="Site-89 Logo" style="height:40px; vertical-align:middle;">
    </a>

    <a href="/departments/">Departments</a>

    <!-- Dropdown for Foundation Archives -->
    <div class="nav-dropdown-parent">
      <a href="#">Foundation Archives <i class="fa-solid fa-caret-down"></i></a>
      <div class="nav-dropdown-content">
        <a href="/archives/">Archives Hub</a>
        <a href="/personnel-files/">Personnel Files</a>
        <a href="/goi-poi/">Groups of Interest / Persons of Interest</a>
        <a href="/anomalies/">Anomalies</a>
        <a href="/research-logs/">Research Logs</a>
        <a href="/incident-reports/">Incident Reports</a>
      </div>
    </div>

    <a href="/guides/">Guides</a>
    <a href="/about/">About</a>
  </div>
  <button id="navToggle" class="nav-toggle" aria-expanded="false" aria-label="Open menu">☰</button>

  <div id="mobileMenu" class="mobile-menu hidden" aria-hidden="true">
    <a href="/departments/">Departments</a>
    <a href="/archives/">Archives Hub</a>
    <a href="/personnel-files/">Personnel Files</a>
    <a href="/goi-poi/">Groups / Persons of Interest</a>
    <a href="/anomalies/">Anomalies</a>
    <a href="/research-logs/">Research Logs</a>
    <a href="/incident-reports/">Incident Reports</a>
    <a href="/about/">About</a>
    <a href="/guides/">Guides</a>
  </div>

  <!-- Right side: socials + login -->
  <div class="nav-right">
    <div class="nav-search" id="navSearch">
      <input id="siteSearchInput" placeholder="Search site…" aria-label="Search site" autocomplete="off">
      <div id="siteSearchResults" class="search-results" role="listbox" aria-hidden="true"></div>
    </div>

    <div class="nav-mail-wrapper">
      <a href="/emails/" id="navMailBtn" class="nav-mail" title="Mail"><i class="fa-solid fa-envelope"></i></a>
    </div>

    <!-- LOGIN BUTTON WITH CLICKABLE DROPDOWN -->
    <div class="nav-login" id="navLogin">
      <i class="fa-solid fa-user"></i>
      <span id="navLoginText">Login</span>

      <!-- Dropdown -->
      <div class="nav-dropdown-content nav-dropdown-login" id="navDropdown">
        <a href="/character-select/">Manage Characters</a>
        <a href="/accounts/">Manage Account</a>
        <a href="#" id="logoutBtn">Logout</a>
      </div>
    </div>
  </div>
</nav>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  /* Navbar layout */
  #main-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background-color: #111;
  }

  .nav-left, .nav-right {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .nav-left a, .nav-right a {
    color: #fff;
    text-decoration: none;
    font-weight: 500;
  }

  .nav-left a:hover, .nav-right a:hover {
    color: #8B0000;
  }

  .nav-dropdown-parent {
    position: relative;
  }

  /* Default dropdown style */
  .nav-dropdown-content {
    display: none;
    position: absolute;
    top: 100%;
    background: #111;
    border: 1px solid #8B0000;
    min-width: 200px;
    z-index: 1000;
    padding: 10px 0;
  }

  .nav-dropdown-content a {
    display: block;
    padding: 8px 12px;
    white-space: nowrap;
  }

  /* Archives open on hover */
  .nav-dropdown-parent:hover > .nav-dropdown-content {
    display: block;
  }

  /* LOGIN DROPDOWN FIXES */
  .nav-login {
    position: relative;
    cursor: pointer;
  }

  .nav-dropdown-login {
    right: 0;
  }

  .hidden {
    display: none !important;
  }

  .nav-toggle {
    display: none;
    background: none;
    border: 1px solid rgba(255,255,255,0.04);
    color: #fff;
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    font-size: 1.2rem;
    cursor: pointer;
  }

  .mobile-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #0e1113;
    padding: 0.9rem 1rem;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 0.45rem;
    border-bottom: 1px solid rgba(255,255,255,0.03);
  }

  .mobile-menu a {
    color: #fff;
    padding: 0.6rem 0.8rem;
    border-radius: 6px;
    text-decoration: none;
  }

  .mobile-menu a:hover { background: rgba(78,250,170,0.03); color: var(--accent-mint); }

  .social-buttons a {
    font-size: 1.2rem;
    transition: color 0.2s;
  }

  .social-buttons a:hover {
    color: #8B0000;
  }
</style>

<script>
  const navLogin = document.getElementById("navLogin");
  const navDropdown = document.getElementById("navDropdown");
  const navLoginText = document.getElementById("navLoginText");

  // Placeholder until real login system added
  const userLoggedIn = true;

  if (userLoggedIn) {
    navLoginText.textContent = "Username"; // Replace with actual username later
  } else {
    navDropdown.classList.add("hidden");
  }

  navLogin.addEventListener("click", (e) => {
    e.stopPropagation(); 
    navDropdown.classList.toggle("hidden");
  });

  document.addEventListener("click", () => {
    navDropdown.classList.add("hidden");
  });

  // Mobile menu toggle
  const navToggle = document.getElementById('navToggle');
  const mobileMenu = document.getElementById('mobileMenu');
  if(navToggle && mobileMenu){
    navToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      mobileMenu.classList.toggle('hidden');
      const expanded = navToggle.getAttribute('aria-expanded') === 'true';
      navToggle.setAttribute('aria-expanded', (!expanded).toString());
      mobileMenu.setAttribute('aria-hidden', (!expanded).toString());
    });

    // Close menu when clicking outside
    document.addEventListener('click', () => {
      if(!mobileMenu.classList.contains('hidden')){
        mobileMenu.classList.add('hidden');
        navToggle.setAttribute('aria-expanded', 'false');
        mobileMenu.setAttribute('aria-hidden', 'true');
      }
    });
  }
</script>

<script>
  // Ensure clicking the login area goes to /accounts/ (absolute)
  document.addEventListener('includesLoaded', () => {
    const navLogin = document.getElementById('navLogin');
    if (!navLogin) return;
    navLogin.addEventListener('click', (e) => {
      // Navigate to accounts folder; account page will handle auth/redirects
      window.location.href = '/accounts/';
    });
  });
</script>

<script>
// Lightweight site search (client-side index) — runs after includes load
document.addEventListener('includesLoaded', () => {
  const input = document.getElementById('siteSearchInput');
  const resultsEl = document.getElementById('siteSearchResults');
  if(!input || !resultsEl) return;

  // Build index from navbar links + a few manual entries
  const anchors = Array.from(document.querySelectorAll('#main-nav a'));
  const manual = [
    { title: 'Home', href: '/' , desc: 'Site-89 Home' },
    { title: 'Archives Hub', href: '/archives/', desc: 'Browse all archives' },
    { title: 'Personnel Files', href: '/personnel-files/', desc: 'Personnel records and PIDs' },
    { title: 'Anomalies', href: '/anomalies/', desc: 'Anomalies index' },
    { title: 'Research Logs', href: '/research-logs/', desc: 'Research entries' },
    { title: 'Incident Reports', href: '/incident-reports/', desc: 'Incident reporting' },
    { title: 'Emails', href: '/emails/', desc: 'Site Mail' },
    { title: 'About', href: '/about/', desc: 'About Site-89' },
    { title: 'Guides', href: '/guides/', desc: 'Operational guides' },
    { title: 'Newcomer Guide', href: '/guides/newcomer-guide/', desc: 'Getting started at Site-89' },
    { title: 'Installation Guide', href: '/guides/installation-guide/', desc: 'Install the Technic Launcher & Site-89 pack' },
    { title: 'Skins Guide', href: '/guides/skins-guide/', desc: 'Skinning, HD skins, and the /setskin command' },
    { title: 'Character Guide', href: '/guides/character-guide/', desc: 'Advice on creating and maintaining characters' },
    { title: 'Roleplay Guide', href: '/guides/roleplay-guide/', desc: 'Rules, syntax, and RP principles' },
    { title: 'Site Management', href: '/site-management/', desc: 'Site management tools' }
  ];

  const indexMap = new Map();
  anchors.forEach(a => {
    const t = a.textContent.trim(); const h = a.getAttribute('href') || '/';
    if(t && !indexMap.has(h)) indexMap.set(h, { title: t, href: h, desc: a.title || '' });
  });
  manual.forEach(m => { if(!indexMap.has(m.href)) indexMap.set(m.href, m); });
  const index = Array.from(indexMap.values());

  let active = -1;
  function renderResults(list){
    resultsEl.innerHTML = '';
    if(!list || list.length === 0){ resultsEl.innerHTML = '<div class="search-empty">No results</div>'; resultsEl.classList.add('active'); resultsEl.setAttribute('aria-hidden','false'); return; }
    list.slice(0,8).forEach((r, i) => {
      const el = document.createElement('div');
      el.className = 'search-result';
      el.setAttribute('role','option');
      el.innerHTML = `<div style="flex:1"><div class='title'>${r.title}</div><div class='desc' style='font-size:.85rem;color:var(--text-light);opacity:.8'>${r.desc || r.href}</div></div>`;
      el.addEventListener('mousedown', (ev)=>{ ev.preventDefault(); window.location.href = r.href; });
      resultsEl.appendChild(el);
    });
    resultsEl.classList.add('active'); resultsEl.setAttribute('aria-hidden','false');
  }

  function clearResults(){ resultsEl.classList.remove('active'); resultsEl.setAttribute('aria-hidden','true'); resultsEl.innerHTML = ''; active = -1; }

  let debounceTimer = null;
  input.addEventListener('input', (e)=>{
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=>{
      const q = input.value.trim().toLowerCase();
      if(!q){ clearResults(); return; }
      const matches = index.filter(it => (it.title||'').toLowerCase().includes(q) || (it.desc||'').toLowerCase().includes(q) || (it.href||'').toLowerCase().includes(q));
      renderResults(matches);
    }, 150);
  });

  input.addEventListener('keydown', (e)=>{
    const items = Array.from(resultsEl.querySelectorAll('.search-result'));
    if(e.key === 'ArrowDown'){ e.preventDefault(); if(items.length){ active = Math.min(items.length-1, active+1); items.forEach((it,i)=> it.classList.toggle('active', i===active)); items[Math.max(active,0)]?.scrollIntoView({block:'nearest'}); }}
    else if(e.key === 'ArrowUp'){ e.preventDefault(); if(items.length){ active = Math.max(0, active-1); items.forEach((it,i)=> it.classList.toggle('active', i===active)); items[active]?.scrollIntoView({block:'nearest'}); }}
    else if(e.key === 'Enter'){ e.preventDefault(); const items = Array.from(resultsEl.querySelectorAll('.search-result')); if(items[active]) items[active].dispatchEvent(new MouseEvent('mousedown')); }
    else if(e.key === 'Escape'){ input.value=''; clearResults(); }
  });

  document.addEventListener('click', (ev)=>{ if(!document.getElementById('navSearch').contains(ev.target)) clearResults(); });
});
</script>
