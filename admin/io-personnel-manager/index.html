<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Site-89 IO Personnel Manager</title>

  <!-- Fonts & CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/assets/css/main.css">

  <!-- Theme System -->
  <script type="module">
    import { ThemeManager } from '/assets/js/theme.js';
    ThemeManager.init();
  </script>

  <style>
    .personnel-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .personnel-card {
      background: var(--bg-card);
      border: 2px solid var(--accent-teal);
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .personnel-card:hover {
      border-color: var(--accent-mint);
      box-shadow: 0 0 16px rgba(78, 250, 170, 0.2);
      transform: translateY(-4px);
    }

    .personnel-card-image {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, var(--accent-teal), var(--bg-dark));
      object-fit: cover;
    }

    .personnel-card-info {
      padding: 1.2rem;
    }

    .personnel-card-name {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--accent-mint);
      margin: 0 0 0.5rem 0;
    }

    .personnel-card-rank {
      font-size: 0.9rem;
      color: var(--accent-teal);
      margin: 0 0 0.3rem 0;
    }

    .personnel-card-dept {
      font-size: 0.85rem;
      color: var(--text-light);
      opacity: 0.8;
      margin: 0;
    }

    .personnel-card-pid {
      font-size: 0.85rem;
      color: var(--text-light);
      opacity: 0.75;
      margin-top: 0.5rem;
      letter-spacing: 1px;
    }

    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); animation: fadeIn 0.3s ease; }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: var(--bg-card); border: 2px solid var(--accent-mint); border-radius: 10px; padding: 2rem; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(78, 250, 170, 0.15); animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid var(--accent-teal); padding-bottom: 1rem; }
    .modal-header h2 { margin: 0; color: var(--accent-mint); font-size: 1.8rem; }
    .modal-close { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--accent-mint); transition: color 0.2s ease; }
    .modal-close:hover { color: var(--accent-teal); }
    .feedback { padding: 1rem; border-radius: 6px; margin-top: 1rem; font-weight: 500; }
    .feedback.success { background: rgba(78, 250, 170, 0.1); color: var(--accent-mint); border: 1px solid rgba(78, 250, 170, 0.3); }
    .feedback.error { background: rgba(176, 0, 0, 0.1); color: #ff6b6b; border: 1px solid rgba(176, 0, 0, 0.3); }
    .access-denied { text-align: center; padding: 3rem; color: var(--text-light); }
    .empty-state { text-align: center; padding: 2rem; color: var(--text-light); opacity: 0.7; }

    .modal-detail-input { width: 100%; padding: 0.6rem; margin: 0.5rem 0 1rem 0; background: var(--bg-soft); border: 1px solid rgba(78, 250, 170, 0.3); border-radius: 6px; color: var(--text-light); font-family: var(--font-body); box-sizing: border-box; }
    .modal-detail-input:focus { outline: none; border-color: var(--accent-mint); box-shadow: 0 0 8px rgba(78, 250, 170, 0.2); }

    .modal-actions { display: flex; gap: 1rem; margin-top: 1.5rem; border-top: 1px solid var(--accent-teal); padding-top: 1.5rem; }
    .modal-actions button { flex: 1; padding: 0.8rem 1.5rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
    .btn-save { background: var(--accent-mint); color: #06100e; }
    .btn-save:hover { background: var(--accent-teal); }
    .btn-cancel { background: transparent; border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-light); }
    .btn-cancel:hover { border-color: var(--accent-mint); color: var(--accent-mint); }

    .edit-photo-section { margin-bottom: 1.5rem; }
    .photo-preview { text-align: center; margin: 1rem 0; }
    .photo-preview img { max-width: 150px; max-height: 150px; border-radius: 8px; border: 2px solid var(--accent-teal); }

    #editAwardsContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 0.75rem; }
    #editAwardsContainer label { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 6px; cursor: pointer; transition: background 0.2s ease; }
    #editAwardsContainer label:hover { background: rgba(78, 250, 170, 0.1); }
  </style>
</head>
<body>

  <!-- Header -->
  <div data-include="/components/header.html"></div>

  <!-- Navbar -->
  <div data-include="/components/navbar.html"></div>

  <!-- Main Content -->
  <section class="content">
    <div class="about-box" style="margin-bottom: 2rem;">
      <h2>IO Personnel Manager</h2>
      <p>Administrative Department Internal Operations - Edit personnel records, ranks, class, and photographs.</p>
    </div>

    <div id="accessDenied" class="access-denied" style="display:none;">
      <i class="fas fa-lock" style="font-size:3rem;margin-bottom:1rem;opacity:0.5;display:block;"></i>
      <h2>Access Denied</h2>
      <p>Only characters from the Administrative Department - Internal Operations can access this page.</p>
    </div>

    <div id="managementContainer" style="display:none;">
      <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
        <input id="searchInput" type="text" placeholder="Search by name, rank, or department..." style="flex: 1; min-width: 200px; padding: 0.6rem; background: var(--bg-card); border: 1px solid rgba(78, 250, 170, 0.3); border-radius: 6px; color: var(--text-light);">
        <select id="sortSelect" style="padding: 0.6rem; background: var(--bg-card); border: 1px solid rgba(78, 250, 170, 0.3); border-radius: 6px; color: var(--text-light);">
          <option value="name">Sort by: Name</option>
          <option value="rank">Sort by: Rank</option>
          <option value="department">Sort by: Department</option>
          <option value="clearance">Sort by: Clearance</option>
        </select>
        <button id="addPIDBtn" style="padding: 0.6rem 1.2rem; background: var(--accent-mint); color: #06100e; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; flex: 0 1 auto;">+ Add Personnel ID</button>
      </div>
    </div>

    <div id="personnelGrid" class="personnel-grid" style="display:none;">
      <div class="empty-state"><i class="fas fa-spinner fa-spin"></i> Loading personnel...</div>
    </div>

    <div id="paginationContainer" style="display:none; text-align:center; margin:2rem 0; gap:0.5rem;">
      <button id="prevPageBtn" style="padding:0.5rem 1rem;background:var(--bg-card);border:1px solid rgba(78,250,170,0.3);border-radius:4px;color:var(--text-light);cursor:pointer;margin-right:0.5rem;">← Previous</button>
      <span id="pageInfo" style="display:inline-block;padding:0.5rem 1rem;color:var(--text-light);"></span>
      <button id="nextPageBtn" style="padding:0.5rem 1rem;background:var(--bg-card);border:1px solid rgba(78,250,170,0.3);border-radius:4px;color:var(--text-light);cursor:pointer;margin-left:0.5rem;">Next →</button>
    </div>

    <div id="pidListSection" class="about-box" style="margin-top: 2rem; display:none;">
      <h3>Personnel ID Directory</h3>
      <p style="margin-bottom: 1rem;">All registered Personnel IDs in the system</p>
      <div id="pidList" style="max-height: 400px; overflow-y: auto;">
        <div class="empty-state"><i class="fas fa-spinner fa-spin"></i> Loading PIDs...</div>
      </div>
    </div>

    <div id="charLinksSection" class="about-box" style="margin-top: 2rem; display:none;">
      <h2>Character Account Links</h2>
      <p>Unlink characters from accounts to reassign them to other users.</p>
      <input id="charSearchInput" placeholder="Search by character name or account UID..." style="width:100%;padding:0.6rem;margin-bottom:1rem;background:var(--bg-card);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:var(--text-light);">
      <div id="charactersList" style="max-height: 500px; overflow-y: auto;">
        <div class="empty-state"><i class="fas fa-spinner fa-spin"></i> Loading characters...</div>
      </div>
    </div>
  </section>

  <!-- PID Modal -->
  <div id="pidModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Personnel ID</h2>
        <button class="modal-close" onclick="window.closePIDModal()">&times;</button>
      </div>

      <form id="pidForm">
        <div>
          <label style="display:block;margin-bottom:0.5rem;color:var(--accent-mint);font-weight:600;">Personnel ID</label>
          <input id="pidInput" class="modal-detail-input" placeholder="e.g., 89A0B123" required>
        </div>
        <div>
          <label style="display:block;margin-bottom:0.5rem;color:var(--accent-mint);font-weight:600;">Name</label>
          <input id="pidNameInput" class="modal-detail-input" placeholder="e.g., John Smith" required>
        </div>
        <div>
          <label style="display:block;margin-bottom:0.5rem;color:var(--accent-mint);font-weight:600;">Clearance Level</label>
          <input id="pidClearanceInput" class="modal-detail-input" type="number" min="0" max="5" required>
        </div>
        <div>
          <label style="display:block;margin-bottom:0.5rem;color:var(--accent-mint);font-weight:600;">Department</label>
          <input id="pidDeptInput" class="modal-detail-input" placeholder="e.g., Research">
        </div>
        <div>
          <label style="display:block;margin-bottom:0.5rem;color:var(--accent-mint);font-weight:600;">Rank</label>
          <input id="pidRankInput" class="modal-detail-input" placeholder="e.g., Specialist">
        </div>
        <div>
          <label style="display:block;margin-bottom:0.5rem;color:var(--accent-mint);font-weight:600;">Class</label>
          <input id="pidClassInput" class="modal-detail-input" placeholder="e.g., A" maxlength="1">
        </div>

        <div id="pidFeedback" style="display:none;"></div>

        <div class="modal-actions">
          <button class="btn-save" type="submit">Create Personnel ID</button>
          <button class="btn-cancel" type="button" onclick="window.closePIDModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit <span id="editPersonnelName"></span></h2>
        <button class="modal-close" onclick="window.closeEditModal()">&times;</button>
      </div>

      <div class="edit-photo-section">
        <label style="display:block;margin-bottom:0.5rem;color:var(--accent-mint);font-weight:600;">Photo URL</label>
        <input id="editPhotoUrl" class="modal-detail-input" placeholder="https://example.com/photo.jpg">
        <div class="photo-preview">
          <img id="editPhotoPreview" src="" alt="Photo preview">
        </div>
      </div>

      <div>
        <label style="display:block;margin-bottom:0.5rem;color:var(--accent-mint);font-weight:600;">Name</label>
        <input id="editName" class="modal-detail-input" placeholder="e.g., John Smith">
      </div>

      <div>
        <label style="display:block;margin-bottom:0.5rem;color:var(--accent-mint);font-weight:600;">Rank</label>
        <input id="editRank" class="modal-detail-input" placeholder="e.g., Captain, Specialist">
      </div>

      <div>
        <label style="display:block;margin-bottom:0.5rem;color:var(--accent-mint);font-weight:600;">Department</label>
        <input id="editDept" class="modal-detail-input" placeholder="e.g., Administrative, Research">
      </div>

      <div>
        <label style="display:block;margin-bottom:0.5rem;color:var(--accent-mint);font-weight:600;">Clearance Level</label>
        <input id="editClearance" class="modal-detail-input" type="number" min="0" max="5" placeholder="e.g., 1, 3, 5">
      </div>

      <div>
        <label style="display:block;margin-bottom:0.5rem;color:var(--accent-mint);font-weight:600;">Personnel Class</label>
        <input id="editClass" class="modal-detail-input" placeholder="e.g., A" maxlength="1">
      </div>

      <div style="margin-top:1.5rem;">
        <label style="display:block;margin-bottom:0.5rem;color:var(--accent-mint);font-weight:600;">Awards & Commendations</label>
        <div id="editAwardsContainer"></div>
      </div>

      <div id="editFeedback" style="display:none;"></div>

      <div class="modal-actions">
        <button class="btn-save" onclick="window.savePersonnelChanges()">Save Changes</button>
        <button class="btn-cancel" onclick="window.closeEditModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div data-include="/components/footer.html"></div>

  <script src="/assets/js/include.js"></script>
  <script type="module" src="/assets/js/auth.js"></script>

  <script type="module">
    import { app, auth, onAuthStateChanged } from "/assets/js/auth.js";
    import { getFirestore, collection, getDocs, query, where, doc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const db = getFirestore(app);
    let currentEditingPID = null;
    let allPersonnel = [];

    function initializeManager() {
      const accessDeniedDiv = document.getElementById('accessDenied');
      const managementContainer = document.getElementById('managementContainer');
      const personnelGrid = document.getElementById('personnelGrid');
      const editModal = document.getElementById('editModal');
      const pidModal = document.getElementById('pidModal');
      const pidForm = document.getElementById('pidForm');
      const editFeedback = document.getElementById('editFeedback');
      const pidFeedback = document.getElementById('pidFeedback');
      const searchInput = document.getElementById('searchInput');
      const addPIDBtn = document.getElementById('addPIDBtn');

      function maskPID(s) {
        if (!s) return '';
        s = String(s);
        if (s.length <= 3) return s;
        const last = s.slice(-3);
        return '█'.repeat(s.length - 3) + last;
      }

      let currentPage = 1;
      const itemsPerPage = 9; // 3x3 grid
      let filteredPersonnel = [];

      function filterAndSortPersonnel() {
        const searchQuery = (searchInput.value || "").toLowerCase();
        const sortBy = (document.getElementById('sortSelect').value || "name");

        filteredPersonnel = allPersonnel.filter(p => {
          const name = (p.name || "").toLowerCase();
          const rank = (p.rank || "").toLowerCase();
          const dept = (p.department || "").toLowerCase();
          return name.includes(searchQuery) || rank.includes(searchQuery) || dept.includes(searchQuery);
        });

        // Sort
        filteredPersonnel.sort((a, b) => {
          switch (sortBy) {
            case 'rank':
              return (a.rank || "").localeCompare(b.rank || "");
            case 'department':
              return (a.department || "").localeCompare(b.department || "");
            case 'clearance':
              return (parseInt(b.clearance) || 0) - (parseInt(a.clearance) || 0);
            case 'name':
            default:
              return (a.name || "").localeCompare(b.name || "");
          }
        });

        currentPage = 1;
        renderGrid();
      }

      function renderGrid() {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = filteredPersonnel.slice(start, end);

        personnelGrid.innerHTML = "";

        if (filteredPersonnel.length === 0) {
          personnelGrid.innerHTML = '<div class="empty-state">No personnel found.</div>';
          document.getElementById('paginationContainer').style.display = 'none';
          return;
        }

        pageItems.forEach(p => {
          const card = document.createElement('div');
          card.className = 'personnel-card';
          const photoUrl = p.profileImage || 'https://files.catbox.moe/aa9390.png';
          
          card.innerHTML = `
            <img src="${photoUrl}" alt="${p.name}" class="personnel-card-image" onerror="this.src='https://files.catbox.moe/aa9390.png'">
            <div class="personnel-card-info">
              <h3 class="personnel-card-name">${p.name || "Unknown"}</h3>
              <p class="personnel-card-rank">${p.rank || "Unassigned"}</p>
              <p class="personnel-card-dept">${p.department || "Unassigned"}</p>
              <p class="personnel-card-pid">PID: ${p.pid || ''}</p>
            </div>
          `;

          card.addEventListener('click', () => window.openEditModal(p));
          personnelGrid.appendChild(card);
        });

        // Update pagination
        const totalPages = Math.ceil(filteredPersonnel.length / itemsPerPage);
        if (totalPages > 1) {
          document.getElementById('paginationContainer').style.display = 'block';
          document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
          document.getElementById('prevPageBtn').disabled = currentPage === 1;
          document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
        } else {
          document.getElementById('paginationContainer').style.display = 'none';
        }
      }

      window.openPIDModal = function() {
        pidForm.reset();
        pidFeedback.style.display = 'none';
        pidModal.classList.add('show');
        document.getElementById('pidInput').focus();
      };

      window.closePIDModal = function() {
        pidModal.classList.remove('show');
        pidFeedback.style.display = 'none';
        pidForm.reset();
      };

      window.openEditModal = async function(person) {
        currentEditingPID = person.pid;
        document.getElementById('editPersonnelName').textContent = person.name || 'Unknown';
        document.getElementById('editPhotoUrl').value = person.profileImage || '';
        document.getElementById('editPhotoPreview').src = person.profileImage || 'https://files.catbox.moe/aa9390.png';
        document.getElementById('editName').value = person.name || '';
        document.getElementById('editRank').value = person.rank || '';
        document.getElementById('editDept').value = person.department || '';
        document.getElementById('editClearance').value = person.clearance || '';

        // Load class and other data from personnel collection
        try {
          const pidDoc = await getDoc(doc(db, 'personnel', person.pid));
          if (pidDoc.exists()) {
            const pidData = pidDoc.data();
            document.getElementById('editClass').value = pidData['class'] || '';
          } else {
            document.getElementById('editClass').value = '';
          }
        } catch (err) {
          console.warn('Error loading PID data:', err);
          document.getElementById('editClass').value = '';
        }

        const awardsContainer = document.getElementById('editAwardsContainer');
        awardsContainer.innerHTML = '';
        const charAwards = person.awards || [];

        try {
          const awardsRes = await fetch('/assets/data/awards.json');
          const allAwards = await awardsRes.json();
          allAwards.forEach(award => {
            const label = document.createElement('label');
            label.style.color = 'var(--text-light)';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = charAwards.includes(award.id);
            checkbox.dataset.awardId = award.id;

            const span = document.createElement('span');
            span.textContent = award.name;

            label.appendChild(checkbox);
            label.appendChild(span);
            awardsContainer.appendChild(label);
          });
        } catch (err) {
          console.warn('Error loading awards:', err);
        }

        editFeedback.style.display = 'none';
        editModal.classList.add('show');
      };

      window.closeEditModal = function() {
        editModal.classList.remove('show');
        currentEditingPID = null;
        editFeedback.style.display = 'none';
      };

      window.savePersonnelChanges = async function() {
        if (!currentEditingPID) return;

        const photoUrl = (document.getElementById('editPhotoUrl').value || '').trim();
        const name = (document.getElementById('editName').value || '').trim();
        const rank = (document.getElementById('editRank').value || '').trim();
        const dept = (document.getElementById('editDept').value || '').trim();
        const clearance = document.getElementById('editClearance').value;
        const personClass = (document.getElementById('editClass').value || '').trim();

        const awardCheckboxes = document.querySelectorAll('#editAwardsContainer input[type="checkbox"]');
        const selectedAwards = [];
        awardCheckboxes.forEach(checkbox => {
          if (checkbox.checked) {
            selectedAwards.push(checkbox.dataset.awardId);
          }
        });

        try {
          const chars = await getDocs(collection(db, 'characters'));
          let charDocId = null;

          chars.forEach(doc => {
            if (doc.data().pid === currentEditingPID) {
              charDocId = doc.id;
            }
          });

          if (!charDocId) {
            window.showEditFeedback('Character not found', 'error');
            return;
          }

          const updateData = {};
          if (photoUrl) updateData.profileImage = photoUrl;
          if (name) updateData.name = name;
          if (rank) updateData.rank = rank;
          if (dept) updateData.department = dept;
          if (clearance !== '') updateData.clearance = Number(clearance);
          if (personClass) updateData['class'] = personClass;
          updateData.awards = selectedAwards;

          await updateDoc(doc(db, 'characters', charDocId), updateData);

          try {
            await setDoc(doc(db, 'personnel', currentEditingPID), {
              name,
              clearance: clearance !== '' ? Number(clearance) : undefined,
              department: dept,
              rank,
              'class': personClass
            });
          } catch (err) {
            console.warn('Could not update personnel record:', err);
          }
          window.showEditFeedback('Personnel record updated successfully!', 'success');
          setTimeout(() => {
            window.closeEditModal();
            filterAndSortPersonnel();
          }, 1500);
        } catch (err) {
          console.error('Error saving changes:', err);
          window.showEditFeedback('Error saving changes: ' + err.message, 'error');
        }
      };

      window.showEditFeedback = function(message, type) {
        editFeedback.className = 'feedback ' + type;
        editFeedback.textContent = message;
        editFeedback.style.display = 'block';
      };

      async function savePID(e) {
        e.preventDefault();
        const pid = (document.getElementById('pidInput').value || '').trim().toUpperCase();
        const name = (document.getElementById('pidNameInput').value || '').trim();
        const clearance = parseInt(document.getElementById('pidClearanceInput').value);
        const dept = (document.getElementById('pidDeptInput').value || '').trim();
        const rank = (document.getElementById('pidRankInput').value || '').trim();
        const personClass = (document.getElementById('pidClassInput').value || '').trim();

        if (!pid || !name || isNaN(clearance)) {
          window.showPIDFeedback('Please fill in all required fields', 'error');
          return;
        }

        try {
          await setDoc(doc(db, 'personnel', pid), {
            id: pid,
            name,
            clearance,
            department: dept,
            rank,
            'class': personClass
          });

          window.showPIDFeedback('Personnel ID created successfully!', 'success');
          pidForm.reset();
          setTimeout(() => {
            window.closePIDModal();
            location.reload();
          }, 1000);
        } catch (err) {
          console.error('Error saving PID:', err);
          window.showPIDFeedback('Error: ' + err.message, 'error');
        }
      }

      window.showPIDFeedback = function(message, type) {
        pidFeedback.className = 'feedback ' + type;
        pidFeedback.textContent = message;
        pidFeedback.style.display = 'block';
      };

      // Event listeners
      document.getElementById('editPhotoUrl').addEventListener('input', (e) => {
        const url = e.target.value.trim();
        if (url) {
          document.getElementById('editPhotoPreview').src = url;
        }
      });

      pidModal.addEventListener('click', (e) => {
        if (e.target === pidModal) window.closePIDModal();
      });

      editModal.addEventListener('click', (e) => {
        if (e.target === editModal) window.closeEditModal();
      });

      pidForm.addEventListener('submit', savePID);
      searchInput.addEventListener('input', () => filterAndSortPersonnel());
      document.getElementById('sortSelect').addEventListener('change', () => filterAndSortPersonnel());
      document.getElementById('prevPageBtn').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderGrid();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
      document.getElementById('nextPageBtn').addEventListener('click', () => {
        const totalPages = Math.ceil(filteredPersonnel.length / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderGrid();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
      addPIDBtn.addEventListener('click', () => window.openPIDModal());

      // Load and display all Personnel IDs
      async function loadPersonnelIDList() {
        try {
          const snaps = await getDocs(collection(db, 'personnel'));
          const arr = [];
          snaps.forEach(s => arr.push({ id: s.id, ...s.data() }));
          arr.sort((a, b) => a.id.localeCompare(b.id));
          
          const pidListDiv = document.getElementById('pidList');
          pidListDiv.innerHTML = '';
          
          arr.forEach(p => {
            const el = document.createElement('div');
            el.style.padding = '.6rem';
            el.style.borderBottom = '1px solid rgba(255,255,255,0.02)';
            
            const strongEl = document.createElement('strong');
            strongEl.textContent = p.id;
            
            const textNode = document.createTextNode(` — ${p.name} `);
            
            const smallEl = document.createElement('small');
            smallEl.style.opacity = '.8';
            smallEl.textContent = `clear:${p.clearance} dept:${p.department || 'N/A'} rank:${p.rank || 'N/A'} class:${p['class'] || 'N/A'}`;
            
            el.appendChild(strongEl);
            el.appendChild(textNode);
            el.appendChild(smallEl);
            pidListDiv.appendChild(el);
          });
        } catch (err) {
          console.error('Error loading PID list:', err);
          document.getElementById('pidList').innerHTML = `<div style="color:var(--accent-red)">Error loading PIDs</div>`;
        }
      }

      // Load and display all characters with their account links
      async function loadCharacters() {
        try {
          const snaps = await getDocs(collection(db, 'characters'));
          const characters = [];
          snaps.forEach(s => {
            characters.push({ id: s.id, ...s.data() });
          });
          
          characters.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
          displayCharacters(characters);
        } catch (err) {
          console.error("Error loading characters:", err);
          document.getElementById('charactersList').innerHTML = `<div style="color:var(--accent-red)">Error loading characters</div>`;
        }
      }

      function displayCharacters(characters) {
        const charList = document.getElementById('charactersList');
        charList.innerHTML = '';
        if (characters.length === 0) {
          charList.innerHTML = '<div>No characters found.</div>';
          return;
        }

        characters.forEach(char => {
          const el = document.createElement('div');
          el.style.cssText = 'padding:0.8rem;border-bottom:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;gap:1rem;';
          
          const linkedUID = char.linkedUID || 'Not linked';
          const displayUID = linkedUID === 'Not linked' ? linkedUID : linkedUID.substring(0, 12) + '...';
          
          const leftDiv = document.createElement('div');
          leftDiv.style.flex = '1';
          
          const nameStrong = document.createElement('strong');
          nameStrong.textContent = char.name || 'Unknown';
          leftDiv.appendChild(nameStrong);
          
          const smallEl = document.createElement('small');
          smallEl.style.cssText = 'opacity:0.8;display:block;margin-top:0.2rem;';
          smallEl.textContent = `ID: ${char.id.substring(0, 8)}... | Linked: ${displayUID} | Dept: ${char.department || 'N/A'}`;
          leftDiv.appendChild(smallEl);
          
          const btn = document.createElement('button');
          btn.className = 'char-unlink-btn';
          btn.dataset.charId = char.id;
          btn.dataset.charName = char.name || 'Unknown';
          btn.style.cssText = 'padding:0.4rem 0.8rem;background:var(--accent-red);border:none;border-radius:4px;color:white;cursor:pointer;font-size:0.85rem;';
          btn.textContent = 'Unlink';
          
          el.appendChild(leftDiv);
          el.appendChild(btn);
          charList.appendChild(el);
        });

        // Wire up unlink buttons
        document.querySelectorAll('.char-unlink-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const charId = btn.dataset.charId;
            const charName = btn.dataset.charName;
            
            if (!confirm(`Unlink character "${charName}" from its account? This will allow it to be linked to another account.`)) {
              return;
            }

            try {
              await updateDoc(doc(db, 'characters', charId), {
                linkedUID: null
              });
              alert(`Character "${charName}" has been unlinked.`);
              loadCharacters();
            } catch (err) {
              alert(`Error unlinking character: ${err.message}`);
            }
          });
        });
      }

      // Search/filter characters
      document.getElementById('charSearchInput').addEventListener('input', async () => {
        const searchTerm = document.getElementById('charSearchInput').value.toLowerCase().trim();
        
        try {
          const snaps = await getDocs(collection(db, 'characters'));
          let characters = [];
          snaps.forEach(s => {
            characters.push({ id: s.id, ...s.data() });
          });

          if (searchTerm) {
            characters = characters.filter(char => 
              (char.name || '').toLowerCase().includes(searchTerm) ||
              (char.linkedUID || '').toLowerCase().includes(searchTerm)
            );
          }

          characters.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
          displayCharacters(characters);
        } catch (err) {
          console.error("Error searching characters:", err);
        }
      });

      // Auth check and load
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          accessDeniedDiv.style.display = 'block';
          return;
        }

        try {
          const q = query(collection(db, 'characters'), where('linkedUID', '==', user.uid));
          const charSnap = await getDocs(q);
          
          let hasAccess = false;
          charSnap.forEach(doc => {
            const char = doc.data();
            if ((char.department || '').includes('AD') || (char.department || '').includes('Internal Operations')) {
              hasAccess = true;
            }
          });

          if (!hasAccess) {
            accessDeniedDiv.style.display = 'block';
            return;
          }

          managementContainer.style.display = 'block';
          personnelGrid.style.display = 'grid';
          document.getElementById('pidListSection').style.display = 'block';
          document.getElementById('charLinksSection').style.display = 'block';
          
          const allChars = await getDocs(collection(db, 'characters'));
          allPersonnel = [];
          allChars.forEach(doc => {
            const char = doc.data();
            if (char.pid) {
              allPersonnel.push({ docId: doc.id, ...char });
            }
          });

          filterAndSortPersonnel();
          loadPersonnelIDList();
          loadCharacters();

        } catch (err) {
          console.error('Error checking access:', err);
          accessDeniedDiv.style.display = 'block';
        }
      });
    }

    // Initialize when includes load
    if (document.readyState === 'loading') {
      document.addEventListener('includesLoaded', initializeManager);
    } else {
      initializeManager();
    }
  </script>

</body>
</html>
