<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Site-89 Manage Characters</title>

  <!-- Fonts & CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <!-- TinyMCE Rich Text Editor -->
  <script src="https://cdn.tiny.cloud/1/wgqechbx2jopsbvntv872129bj4qw3wbxsvy35z27edgkqz4/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>

  <!-- Theme System -->
  <script type="module">
    import { ThemeManager } from '/assets/js/theme.js';
    ThemeManager.init();
  </script>

  <style>
    .character-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .character-card {
      background: var(--bg-card);
      border: 2px solid var(--accent-teal);
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    html[data-theme="light"] .character-card {
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .character-card:hover {
      border-color: var(--accent-mint);
      box-shadow: 0 0 16px rgba(78, 250, 170, 0.2);
      transform: translateY(-4px);
    }

    .character-card-image {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, var(--accent-teal), var(--bg-dark));
      object-fit: cover;
    }

    html[data-theme="light"] .character-card-image {
      background: linear-gradient(135deg, var(--accent-teal), #e8f5f3);
    }

    .character-card-info {
      padding: 1.2rem;
    }

    .character-card-name {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--accent-mint);
      margin: 0 0 0.5rem 0;
    }

    .character-card-rank {
      font-size: 0.9rem;
      color: var(--accent-teal);
      margin: 0 0 0.3rem 0;
    }

    .character-card-dept {
      font-size: 0.85rem;
      color: var(--text-light);
      opacity: 0.8;
      margin: 0;
    }

    .character-badge {
      display: inline-block;
      margin-top: 0.8rem;
      padding: 0.3rem 0.8rem;
      background: rgba(78, 250, 170, 0.1);
      border: 1px solid rgba(78, 250, 170, 0.3);
      border-radius: 6px;
      font-size: 0.75rem;
      color: var(--accent-mint);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .character-actions {
      display: flex;
      gap: 0.6rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-select {
      flex: 1;
      padding: 0.5rem 0.8rem;
      background: var(--accent-mint);
      color: var(--bg-dark);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }

    .btn-select:hover {
      background: var(--accent-teal);
      transform: scale(1.05);
    }

    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--text-light);
      opacity: 0.7;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.4;
    }

    .empty-state p {
      margin: 0.5rem 0;
    }

    .empty-state a {
      display: inline-block;
      margin-top: 1rem;
      padding: 0.7rem 1.5rem;
      background: var(--accent-mint);
      color: var(--bg-dark);
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .empty-state a:hover {
      background: var(--accent-teal);
    }

    .auth-required {
      text-align: center;
      padding: 2rem;
      color: var(--accent-red);
    }

    .info-box {
      background: rgba(78, 250, 170, 0.05);
      border: 1px solid rgba(78, 250, 170, 0.2);
      border-left: 4px solid var(--accent-mint);
      padding: 1rem 1.2rem;
      border-radius: 6px;
      margin-bottom: 2rem;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    html[data-theme="light"] .info-box {
      background: rgba(0, 163, 137, 0.05);
      border: 1px solid rgba(0, 163, 137, 0.15);
    }

    .btn-create {
      display: inline-block;
      margin: 2rem 0 1rem 0;
      padding: 0.8rem 1.5rem;
      background: var(--accent-mint);
      color: var(--bg-dark);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-create:hover {
      background: var(--accent-teal);
      transform: scale(1.05);
    }

    .char-creation-form, .char-editor {
      background: var(--bg-card);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1.5rem 0;
      display: none;
    }

    .char-creation-form.active, .char-editor.active {
      display: block;
    }

    .char-creation-form input, .char-creation-form textarea, .char-editor input, .char-editor textarea {
      width: 100%;
      padding: 0.6rem;
      margin: 0.6rem 0;
      border-radius: 6px;
      border: 1px solid var(--card-border);
      background: var(--bg-panel);
      color: var(--text-light);
      font-family: var(--font-body);
    }

    .char-creation-form textarea, .char-editor textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-row {
      display: flex;
      gap: 1rem;
      margin: 0.6rem 0;
    }

    .form-row input {
      flex: 1;
    }

    .pid-lookup-btn {
      padding: 0.6rem 1rem;
      background: var(--accent-teal);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .pid-lookup-btn:hover {
      background: var(--accent-mint);
    }

    .pid-confirm-box {
      display: none;
      background: rgba(78, 250, 170, 0.05);
      border: 1px solid rgba(78, 250, 170, 0.2);
      border-left: 4px solid var(--accent-mint);
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
    }

    .pid-confirm-box.active {
      display: block;
    }

    .pid-confirm-box button {
      padding: 0.5rem 1rem;
      margin-right: 0.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    .pid-confirm-yes {
      background: var(--accent-mint);
      color: var(--bg-dark);
    }

    .pid-confirm-no {
      background: var(--accent-teal);
      color: #fff;
    }

    .form-feedback {
      margin-top: 0.8rem;
      padding: 0.8rem;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .form-feedback.success {
      background: rgba(78, 250, 170, 0.1);
      color: var(--accent-mint);
      border: 1px solid rgba(78, 250, 170, 0.2);
    }

    .form-feedback.error {
      background: rgba(176, 0, 0, 0.1);
      color: var(--accent-red);
      border: 1px solid rgba(176, 0, 0, 0.2);
    }

    .form-buttons {
      display: flex;
      gap: 0.8rem;
      margin-top: 1rem;
    }

    .form-buttons button {
      flex: 1;
      padding: 0.6rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-submit {
      background: var(--accent-mint);
      color: var(--bg-dark);
    }

    .btn-submit:hover {
      background: var(--accent-teal);
    }

    .btn-cancel {
      background: var(--bg-panel);
      color: var(--text-light);
      border: 1px solid var(--card-border);
    }

    .btn-cancel:hover {
      background: rgba(78, 250, 170, 0.05);
    }

    .char-editor-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .char-editor-image {
      width: 120px;
      height: 120px;
      border-radius: 8px;
      border: 2px solid var(--accent-teal);
      object-fit: cover;
    }

    html[data-theme="light"] .char-creation-form,
    html[data-theme="light"] .char-editor {
      border-color: #D0D0D0;
    }

    html[data-theme="light"] .char-creation-form input,
    html[data-theme="light"] .char-creation-form textarea,
    html[data-theme="light"] .char-editor input,
    html[data-theme="light"] .char-editor textarea {
      background: #FFFFFF;
      border-color: #D0D0D0;
      color: #1A1A1A;
    }
  
  </style>
</head>
<body>

  <!-- Header -->
  <div data-include="/components/header.html"></div>

  <!-- Navbar -->
  <div data-include="/components/navbar.html"></div>

  <!-- Main Content -->
  <section class="content">
    <div class="about-box" style="margin-bottom: 1rem;">
      <h2>Manage Your Characters</h2>
      <p>View, select, and manage your characters. You may only see and edit characters that belong to you.</p>
    </div>

    <div class="info-box">
      <i class="fa-solid fa-circle-info"></i> Select a character to use it for your activities on Site-89. Your selection is saved and will persist across sessions.
    </div>

    <div id="characterGrid" class="character-grid">
      <div class="empty-state"><i class="fas fa-spinner fa-spin"></i> Loading your characters...</div>
    </div>

    <!-- Create New Character Button -->
    <button id="createCharBtn" class="btn-create">
      <i class="fas fa-plus"></i> Create New Character
    </button>

    <!-- Character Creation Form -->
    <div id="charCreationForm" class="char-creation-form">
      <h3>Create New Character</h3>
      <p style="opacity: 0.8; margin-bottom: 1rem;">Enter your Personnel ID to create a character. The name, department, rank, and clearance will be populated from your personnel record.</p>
      
      <form id="charFormElement">
        <div class="form-row">
          <input type="text" id="charPID" placeholder="Personnel ID (e.g., 89A0B123)" required>
          <button type="button" id="pidLookupBtn" class="pid-lookup-btn">Lookup</button>
        </div>

        <div id="pidConfirmBox" class="pid-confirm-box">
          <div id="pidConfirmText" style="margin-bottom: 1rem;"></div>
          <button type="button" id="pidConfirmYes" class="pid-confirm-yes">Yes — This is correct</button>
          <button type="button" id="pidConfirmNo" class="pid-confirm-no">No — Edit</button>
        </div>

        <input type="text" id="charName" placeholder="Character Name" required>
        <input type="text" id="charDept" placeholder="Department" required disabled>
        <input type="text" id="charRank" placeholder="Rank" required disabled>
        <input type="text" id="charClearance" placeholder="Clearance Level" required disabled>

        <div class="form-buttons">
          <button type="submit" class="btn-submit">Create Character</button>
          <button type="button" id="cancelCharForm" class="btn-cancel">Cancel</button>
        </div>
      </form>
      <div id="charFormFeedback" class="form-feedback" style="display: none;"></div>
    </div>

    <!-- Character Profile Editor -->
    <div id="charEditor" class="char-editor">
      <h3>Edit Character Profile: <span id="editCharName"></span></h3>
      
      <div class="char-editor-header">
        <img id="charEditorImage" class="char-editor-image" src="https://via.placeholder.com/150" alt="Character photo">
        <div style="flex: 1;">
          <input type="text" id="charImgurLink" placeholder="Catbox image URL (e.g., https://files.catbox.moe/...)">
          <button type="button" id="updatePhotoBtn" style="width: 100%; margin-top: 0.5rem; padding: 0.6rem; background: var(--accent-teal); color: #fff; border: none; border-radius: 6px; cursor: pointer;">Update Photo</button>
        </div>
      </div>

      <label style="display: block; margin: 1rem 0 0.5rem 0; color: var(--text-light);">Rank:</label>
      <input type="text" id="charEditorRank" placeholder="e.g., Junior Researcher">

      <label style="display: block; margin: 1rem 0 0.5rem 0; color: var(--text-light);">Bio:</label>
      <textarea id="charEditorBio" placeholder="Enter character bio..."></textarea>

      <div class="form-buttons">
        <button id="saveCharProfileBtn" class="btn-submit">Save Profile</button>
        <button type="button" id="closeCharEditor" class="btn-cancel">Cancel</button>
      </div>
      <div id="charEditorFeedback" class="form-feedback" style="display: none;"></div>
    </div>
  </section>

  <!-- Footer -->
  <div data-include="/components/footer.html"></div>

  <script src="/assets/js/include.js"></script>
  <script type="module" src="/assets/js/auth.js"></script>

  <script type="module">
    import { app, auth } from "/assets/js/auth.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where, addDoc, updateDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const db = getFirestore(app);
    let currentUser = null;  // Store current user for use in event listeners

    // Load only logged-in user's characters (linked to their account)
    async function loadCharacters(userId) {
      const characterGrid = document.getElementById("characterGrid");
      characterGrid.innerHTML = "";

      try {
        // Query characters linked to this user's account
        const q = query(
          collection(db, "characters"), 
          where("linkedUID", "==", userId)
        );
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          characterGrid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
              <i class="fas fa-masks-theater"></i>
              <p><strong>No characters yet</strong></p>
              <p>Create your first character to get started.</p>
            </div>
          `;
          return;
        }

        const characters = [];
        querySnapshot.forEach(docSnap => {
          characters.push({ id: docSnap.id, ...docSnap.data() });
        });

        // Check if user has reached character limit (4 max)
        const createCharBtn = document.getElementById("createCharBtn");
        if (characters.length >= 4) {
          createCharBtn.disabled = true;
          createCharBtn.style.opacity = "0.5";
          createCharBtn.style.cursor = "not-allowed";
          createCharBtn.title = "Character limit reached (4 maximum)";
        } else {
          createCharBtn.disabled = false;
          createCharBtn.style.opacity = "1";
          createCharBtn.style.cursor = "pointer";
          createCharBtn.title = "";
        }

        // Sort by name
        characters.sort((a, b) => (a.name || "").localeCompare(b.name || ""));

        characters.forEach(char => {
          const card = document.createElement("div");
          card.className = "character-card";

          const photoUrl = char.profileImage || '#file:dataunavailable.png';
          const isSelected = localStorage.getItem("selectedCharacter") ? 
            JSON.parse(localStorage.getItem("selectedCharacter")).id === char.id : false;

          // Use safe DOM methods instead of innerHTML to prevent XSS
          const img = document.createElement("img");
          img.src = photoUrl;
          img.alt = char.name || "Character";
          img.className = "character-card-image";
          img.onerror = function() { this.src = 'https://files.catbox.moe/aa9390.png'; };

          const info = document.createElement("div");
          info.className = "character-card-info";

          const nameEl = document.createElement("h3");
          nameEl.className = "character-card-name";
          nameEl.textContent = char.name || "Unknown";

          const rankEl = document.createElement("p");
          rankEl.className = "character-card-rank";
          rankEl.textContent = char.rank || "Unassigned";

          const deptEl = document.createElement("p");
          deptEl.className = "character-card-dept";
          deptEl.textContent = char.department || "Unassigned";

          const actions = document.createElement("div");
          actions.className = "character-actions";

          const selectBtn = document.createElement("button");
          selectBtn.className = "btn-select";
          selectBtn.setAttribute("data-char-id", char.id);
          // Store only the ID securely, not the full data object with innerHTML
          selectBtn.setAttribute("data-char-id-only", char.id);
          
          if (isSelected) {
            selectBtn.style.background = "rgba(78, 250, 170, 0.2)";
            selectBtn.style.border = "1px solid var(--accent-mint)";
            selectBtn.style.color = "var(--accent-mint)";
            selectBtn.innerHTML = '<i class="fa-solid fa-check"></i> Selected';
          } else {
            selectBtn.innerHTML = '<i class="fa-solid fa-arrow-right"></i> Select';
          }

          actions.appendChild(selectBtn);
          info.appendChild(nameEl);
          info.appendChild(rankEl);
          info.appendChild(deptEl);
          info.appendChild(actions);
          card.appendChild(img);
          card.appendChild(info);
          characterGrid.appendChild(card);
        });

        // Attach event listeners to select buttons
        document.querySelectorAll('.btn-select').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const charId = btn.getAttribute('data-char-id-only');
            const isAlreadySelected = localStorage.getItem("selectedCharacter") ? 
              JSON.parse(localStorage.getItem("selectedCharacter")).id === charId : false;
            
            // If already selected, don't reload
            if (isAlreadySelected) return;
            
            // SECURITY: Fetch the character data fresh from Firebase to prevent tampering
            // Never trust the data attribute or any DOM-stored version
            try {
              const charRef = doc(db, "characters", charId);
              const charSnap = await getDoc(charRef);
              
              if (!charSnap.exists()) {
                console.error("Character not found in database");
                return;
              }

              const charData = charSnap.data();
              
              // Verify the character belongs to the current user
              if (!currentUser || charData.linkedUID !== currentUser.uid) {
                console.error("Character linked to different user or currentUser not set");
                alert("This character does not belong to you.");
                return;
              }

              // Now safe to save to localStorage
              localStorage.setItem('selectedCharacter', JSON.stringify({
                id: charSnap.id,
                name: charData.name,
                department: charData.department,
                rank: charData.rank,
                clearance: charData.clearance,
                profileImage: charData.profileImage,
                linkedUID: charData.linkedUID
              }));
              
              // Reload to update UI
              location.reload();
            } catch (err) {
              console.error("Error selecting character:", err);
              alert("Error selecting character. Please try again.");
            }
          });
        });

      } catch (err) {
        console.error("Error loading characters:", err);
        characterGrid.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;"><i class="fas fa-exclamation-triangle"></i><p>Error loading characters.</p></div>';
      }
    }

    // Check auth state and load characters
    onAuthStateChanged(auth, (user) => {
      const characterGrid = document.getElementById("characterGrid");
      if (!user) {
        currentUser = null;
        characterGrid.innerHTML = `
          <div class="empty-state auth-required" style="grid-column: 1 / -1;">
            <i class="fas fa-lock"></i>
            <p>You must be logged in to manage characters.</p>
            <a href="/login/" style="color: var(--accent-mint);">Login or Create Account</a>
          </div>
        `;
        return;
      }
      currentUser = user;  // Store user in module-level variable
      loadCharactersWithEdit(user.uid);
    });

    // Sticky nav
    document.addEventListener("scroll", () => {
      const nav = document.getElementById("main-nav");
      if (nav) {
        nav.classList.toggle("is-sticky", window.scrollY > 120);
      }
    });

    // CHARACTER CREATION AND EDITING
    let pidMatchedData = null;
    let pidConfirmed = false;
    let currentEditingCharId = null;

    const createCharBtn = document.getElementById("createCharBtn");
    const charCreationForm = document.getElementById("charCreationForm");
    const charFormElement = document.getElementById("charFormElement");
    const cancelCharForm = document.getElementById("cancelCharForm");
    const charFormFeedback = document.getElementById("charFormFeedback");
    const pidLookupBtn = document.getElementById("pidLookupBtn");
    const charPID = document.getElementById("charPID");
    const pidConfirmBox = document.getElementById("pidConfirmBox");
    const pidConfirmText = document.getElementById("pidConfirmText");
    const pidConfirmYes = document.getElementById("pidConfirmYes");
    const pidConfirmNo = document.getElementById("pidConfirmNo");
    const charName = document.getElementById("charName");
    const charDept = document.getElementById("charDept");
    const charRank = document.getElementById("charRank");
    const charClearance = document.getElementById("charClearance");

    const charEditor = document.getElementById("charEditor");
    const charEditorImage = document.getElementById("charEditorImage");
    const charImgurLink = document.getElementById("charImgurLink");
    const updatePhotoBtn = document.getElementById("updatePhotoBtn");
    const charEditorRank = document.getElementById("charEditorRank");
    const charEditorBio = document.getElementById("charEditorBio");
    const saveCharProfileBtn = document.getElementById("saveCharProfileBtn");
    const closeCharEditor = document.getElementById("closeCharEditor");
    const charEditorFeedback = document.getElementById("charEditorFeedback");
    const editCharName = document.getElementById("editCharName");

    function showFeedback(element, message, type) {
      element.textContent = message;
      element.className = `form-feedback ${type}`;
      element.style.display = "block";
    }

    // Force PID to uppercase
    charPID.addEventListener('input', (e) => {
      e.target.value = e.target.value.toUpperCase();
    });

    function resetCharForm() {
      pidMatchedData = null;
      pidConfirmed = false;
      pidConfirmBox.classList.remove("active");
      charPID.value = "";
      charName.value = "";
      charDept.value = "";
      charRank.value = "";
      charClearance.value = "";
      charName.disabled = true;
      charDept.disabled = true;
      charRank.disabled = true;
      charClearance.disabled = true;
      pidLookupBtn.disabled = false;
      charPID.disabled = false;
      charFormFeedback.style.display = "none";
    }

    // Create character button
    createCharBtn.addEventListener("click", () => {
      if (createCharBtn.disabled) {
        return; // Prevent opening form if disabled
      }
      charCreationForm.classList.add("active");
      createCharBtn.style.display = "none";
      resetCharForm();
    });

    // Cancel form
    cancelCharForm.addEventListener("click", () => {
      charCreationForm.classList.remove("active");
      createCharBtn.style.display = "inline-block";
      resetCharForm();
    });

    // PID Lookup
    pidLookupBtn.addEventListener("click", async () => {
      const pid = (charPID.value || "").trim();
      const user = auth.currentUser;
      pidConfirmed = false;
      pidMatchedData = null;
      pidConfirmBox.classList.remove("active");
      charFormFeedback.style.display = "none";

      if (!pid) {
        showFeedback(charFormFeedback, "Enter a Personnel ID to lookup.", "error");
        return;
      }

      if (!user) {
        showFeedback(charFormFeedback, "You must be logged in to lookup a Personnel ID.", "error");
        return;
      }

      try {
        // Check if a character with this PID already exists
        const existingCharQuery = query(collection(db, "characters"), where("pid", "==", pid));
        const existingCharSnap = await getDocs(existingCharQuery);
        
        if (!existingCharSnap.empty) {
          const existingChar = existingCharSnap.docs[0].data();
          
          // Check if the existing character belongs to the current user
          if (existingChar.linkedUID !== user.uid) {
            showFeedback(charFormFeedback, "This Personnel ID is already assigned to another account. You cannot share or duplicate characters.", "error");
            return;
          } else {
            showFeedback(charFormFeedback, "You already have a character with this Personnel ID. Create a new character or edit your existing one.", "error");
            return;
          }
        }

        const pidRef = doc(db, "personnel", pid);
        const snap = await getDoc(pidRef);
        if (!snap.exists()) {
          showFeedback(charFormFeedback, "PID not found. Contact Internal Affairs to add this PID.", "error");
          return;
        }

        pidMatchedData = snap.data();
        charName.value = pidMatchedData.name || "";
        charDept.value = pidMatchedData.department || "";
        charRank.value = pidMatchedData.rank || "";
        charClearance.value = pidMatchedData.clearance || "";

        charName.disabled = false;
        charDept.disabled = true;
        charRank.disabled = true;
        charClearance.disabled = true;

        pidConfirmText.textContent = `Found personnel: ${pidMatchedData.name} — does this look right?`;
        pidConfirmBox.classList.add("active");
      } catch (err) {
        console.error("PID lookup error:", err);
        let errorMsg = "Lookup failed. ";
        if (err.code === 'permission-denied') {
          errorMsg += "Permission denied. Please ensure you're logged in and have proper access.";
        } else if (err.code === 'unavailable') {
          errorMsg += "Database connection unavailable. Check your internet connection.";
        } else {
          errorMsg += "Error: " + (err.message || "Unknown error. Check console for details.");
        }
        showFeedback(charFormFeedback, errorMsg, "error");
      }
    });

    // Confirm PID
    pidConfirmYes.addEventListener("click", () => {
      pidConfirmed = true;
      pidConfirmBox.classList.remove("active");
      showFeedback(charFormFeedback, "Personnel confirmed — you may now create the character.", "success");
      charPID.disabled = true;
      pidLookupBtn.disabled = true;
    });

    pidConfirmNo.addEventListener("click", () => {
      pidConfirmed = false;
      pidConfirmBox.classList.remove("active");
      charFormFeedback.style.display = "none";
      charName.disabled = false;
      charName.focus();
    });

    // Submit character form
    charFormElement.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return alert("You must be logged in!");

      const pid = (charPID.value || "").trim();
      const name = charName.value.trim();

      if (!pid || !pidMatchedData || !pidConfirmed) {
        showFeedback(charFormFeedback, "You must lookup and confirm a valid Personnel ID.", "error");
        return;
      }

      try {
        const payload = {
          uid: user.uid,
          linkedUID: user.uid,
          pid: pid,
          name: name || pidMatchedData.name || "",
          department: pidMatchedData.department || "",
          rank: pidMatchedData.rank || "",
          clearance: Number(pidMatchedData.clearance) || 1,
          bio: "",
          profileImage: ""
        };

        await addDoc(collection(db, "characters"), payload);
        showFeedback(charFormFeedback, "Character created successfully!", "success");
        charFormElement.reset();
        resetCharForm();
        setTimeout(() => location.reload(), 1000);
      } catch (err) {
        showFeedback(charFormFeedback, "Error creating character: " + err.message, "error");
      }
    });

    // Character editing
    closeCharEditor.addEventListener("click", () => {
      charEditor.classList.remove("active");
      charEditorFeedback.style.display = "none";
      // Remove TinyMCE when closing modal
      if (tinymce.get('charEditorBio')) {
        tinymce.remove('#charEditorBio');
      }
    });

    updatePhotoBtn.addEventListener("click", () => {
      const url = charImgurLink.value.trim();
      if (!url) {
        showFeedback(charEditorFeedback, "Please enter an Imgur URL", "error");
        return;
      }

      if (!url.includes("imgur")) {
        showFeedback(charEditorFeedback, "Please enter a valid Imgur URL", "error");
        return;
      }

      charEditorImage.src = url;
      showFeedback(charEditorFeedback, "Photo updated (will save when you click Save Profile)", "success");
    });

    saveCharProfileBtn.addEventListener("click", async () => {
      if (!currentEditingCharId) return;

      saveCharProfileBtn.disabled = true;
      saveCharProfileBtn.textContent = "Saving...";

      try {
        // Get bio from TinyMCE editor
        const editor = tinymce.get('charEditorBio');
        const bioContent = editor ? editor.getContent() : charEditorBio.value;

        const charRef = doc(db, "characters", currentEditingCharId);
        await updateDoc(charRef, {
          rank: charEditorRank.value,
          bio: bioContent,
          profileImage: charEditorImage.src
        });

        showFeedback(charEditorFeedback, "Profile saved successfully!", "success");
        saveCharProfileBtn.disabled = false;
        saveCharProfileBtn.textContent = "Save Profile";
        setTimeout(() => location.reload(), 1000);
      } catch (err) {
        showFeedback(charEditorFeedback, "Error saving profile: " + err.message, "error");
        saveCharProfileBtn.disabled = false;
        saveCharProfileBtn.textContent = "Save Profile";
      }
    });

    // Add edit button to character cards
    function addEditButtons() {
      document.querySelectorAll(".character-card").forEach((card) => {
        const charId = card.querySelector(".btn-select")?.getAttribute("data-char-id-only");
        
        if (!charId || card.querySelector(".btn-edit")) return; // Already has edit button

        const editBtn = document.createElement("button");
        editBtn.className = "btn-select btn-edit";
        editBtn.style.background = "var(--accent-teal)";
        editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
        editBtn.type = "button";

        editBtn.addEventListener("click", async (e) => {
          e.stopPropagation();
          
          try {
            // SECURITY: Fetch fresh character data from Firebase
            const charRef = doc(db, "characters", charId);
            const charSnap = await getDoc(charRef);
            
            if (!charSnap.exists()) {
              alert("Character not found.");
              return;
            }

            const char = charSnap.data();
            
            // Verify ownership
            if (char.linkedUID !== auth.currentUser?.uid) {
              alert("This character does not belong to you.");
              return;
            }

            currentEditingCharId = charId;
            editCharName.textContent = char.name || "Unknown";
            charEditorRank.value = char.rank || "";
            charImgurLink.value = char.profileImage || "";
            charEditorImage.src = char.profileImage || "https://via.placeholder.com/150";
            
            // Initialize TinyMCE if not already done
            if (!tinymce.get('charEditorBio')) {
              tinymce.init({
                selector: '#charEditorBio',
                plugins: 'lists link image code textcolor',
                toolbar: 'undo redo | formatselect | bold italic underline strikethrough | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | removeformat code',
                menubar: 'file edit view insert format tools',
                height: 300,
                skin: 'oxide-dark',
                content_css: 'dark',
                setup: function(editor) {
                  editor.on('change', function() {
                    tinymce.get('charEditorBio').save();
                  });
                }
              });
              // Wait a moment for TinyMCE to initialize, then load content
              setTimeout(() => {
                const editor = tinymce.get('charEditorBio');
                if (editor) {
                  editor.setContent(char.bio || "");
                } else {
                  charEditorBio.value = char.bio || "";
                }
              }, 100);
            } else {
              // TinyMCE already initialized, just load content
              const editor = tinymce.get('charEditorBio');
              if (editor) {
                editor.setContent(char.bio || "");
              } else {
                charEditorBio.value = char.bio || "";
              }
            }
            
            charEditor.classList.add("active");
            charEditorFeedback.style.display = "none";
          } catch (err) {
            console.error("Error opening editor:", err);
            alert("Error opening character editor.");
          }
        });

        card.querySelector(".character-actions").appendChild(editBtn);
      });
    }

    // Load characters with edit buttons
    const originalLoadCharacters = loadCharacters;
    async function loadCharactersWithEdit(userId) {
      await originalLoadCharacters(userId);
      addEditButtons();
    }
  </script>

</body>
</html>
