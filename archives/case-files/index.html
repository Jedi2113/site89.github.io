<!DOCTYPE html>
<html lang="en">
<head>
  <!-- SECURITY LOCKDOWN - LOAD FIRST -->
  <meta charset="utf-8">
  <script src="/assets/js/secure-access.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="required-clearance" content="0">
  <title>Case Files — Site-89</title>
  <link rel="stylesheet" href="/assets/css/main.css">
  <!-- Theme System -->
  <script type="module">
    import { ThemeManager } from '/assets/js/theme.js';
    ThemeManager.init();
  </script>
</head>
<body>
  <div data-include="/components/header.html"></div>
  <div data-include="/components/navbar.html"></div>

  <main class="content">
    <section class="about-box">
      <h1>Case Files</h1>
      <p>Repository for Internal Affairs case reports. Viewing requires security clearance ≥ 0. Creating and editing entries requires membership of IA or RAISA departments.</p>
    </section>

    <section class="about-box">
      <style>
        /* Header / Toolbar */
        .cf-header{display:flex;justify-content:space-between;align-items:center;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap}
        .cf-search{padding:.5rem .8rem;border-radius:6px;border:1px solid rgba(255,255,255,0.08);min-width:220px;background:var(--bg-dark);color:var(--text-primary)}
        .cf-btn-new{padding:.5rem 1rem;border-radius:6px;background:var(--accent-mint);color:var(--bg-dark);border:none;font-weight:600;cursor:pointer;transition:all .2s}
        .cf-btn-new:hover{background:var(--accent-teal);transform:translateY(-1px)}

        /* Table */
        .cf-table{width:100%;border-collapse:collapse;margin-top:1rem;background:var(--bg-card);border-radius:8px;overflow:hidden}
        .cf-table thead{background:linear-gradient(90deg,var(--accent-mint),var(--accent-teal));color:#081413;font-weight:700}
        .cf-table th,.cf-table td{padding:.9rem .75rem;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03)}
        .cf-table tbody tr{cursor:pointer;transition:background .15s}
        .cf-table tbody tr:hover{background:rgba(78,250,170,0.04)}
        .cf-link{color:inherit;text-decoration:none;font-weight:600}
        .cf-link:hover{color:var(--accent-mint)}
        .cf-tag{display:inline-block;padding:.2rem .5rem;margin-right:.3rem;border-radius:4px;font-size:.85rem;background:rgba(78,250,170,0.1);color:var(--accent-mint);border:1px solid rgba(78,250,170,0.2)}
        .cf-empty{padding:2rem;text-align:center;color:var(--text-light)}

        /* Modal */
        .cf-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:2000;align-items:center;justify-content:center}
        .cf-modal[aria-hidden="false"]{display:flex}
        .cf-modal-content{background:var(--bg-card);border-radius:10px;max-width:1100px;width:96%;max-height:90vh;overflow-y:auto;padding:1.5rem;border:1px solid rgba(255,255,255,0.06)}
        .cf-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid rgba(255,255,255,0.06)}
        .cf-close{background:transparent;border:none;font-size:1.5rem;color:var(--text-light);cursor:pointer;padding:0;width:30px;height:30px}
        .cf-close:hover{color:var(--accent-red)}

        /* Form */
        .cf-form label{display:block;margin-bottom:1rem;font-weight:600}
        .cf-form input,.cf-form textarea,.cf-form select{width:100%;padding:.6rem;margin-top:.3rem;background:var(--bg-dark);border:1px solid rgba(255,255,255,0.08);border-radius:6px;color:var(--text-primary);font-family:inherit}
        .cf-form input:focus,.cf-form textarea:focus,.cf-form select:focus{outline:none;border-color:var(--accent-mint);box-shadow:0 0 0 2px rgba(78,250,170,0.1)}
        .cf-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}
        .cf-form textarea{min-height:200px;font-family:monospace;resize:vertical}
        .cf-preview{background:var(--bg-dark);border:1px solid rgba(255,255,255,0.08);border-radius:6px;padding:1rem;min-height:200px;overflow-y:auto;line-height:1.6}
        .cf-preview h1,.cf-preview h2,.cf-preview h3{color:var(--accent-mint);margin-top:1rem}
        .cf-preview code{background:rgba(0,0,0,0.3);padding:.2rem .4rem;border-radius:3px}
        .cf-preview pre{background:rgba(0,0,0,0.3);padding:1rem;border-radius:6px;overflow-x:auto}
        .cf-preview a{color:var(--accent-mint)}

        /* Buttons */
        .cf-btn-primary{padding:.6rem 1.2rem;background:var(--accent-mint);color:var(--bg-dark);border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:all .2s}
        .cf-btn-primary:hover{background:var(--accent-teal);transform:translateY(-1px)}
        .cf-btn-secondary{padding:.6rem 1.2rem;background:transparent;color:var(--text-light);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;transition:all .2s}
        .cf-btn-secondary:hover{border-color:var(--accent-mint);color:var(--accent-mint)}
        .cf-actions{display:flex;gap:.5rem;margin-top:1.5rem}
        .cf-status{margin-top:.5rem;font-size:.9rem}

        /* Version Management */
        .cf-version-block{background:var(--bg-dark);border:1px solid rgba(255,255,255,0.08);border-radius:6px;padding:1rem;margin-bottom:1rem;position:relative}
        .cf-version-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
        .cf-version-label{font-weight:600;color:var(--accent-mint)}
        .cf-version-remove{background:transparent;border:none;color:var(--accent-red);cursor:pointer;padding:.2rem .5rem;font-size:.9rem}
        .cf-version-remove:hover{text-decoration:underline}
        .cf-version-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
        .cf-version-editor textarea{min-height:250px;font-family:monospace;resize:vertical;width:100%;padding:.6rem;background:var(--bg-card);border:1px solid rgba(255,255,255,0.08);border-radius:6px;color:var(--text-primary)}
        .cf-version-preview{background:var(--bg-card);border:1px solid rgba(255,255,255,0.08);border-radius:6px;padding:1rem;min-height:250px;overflow-y:auto;line-height:1.6}

        /* Case Report Styling */
        .case-report-view{font-family:system-ui,-apple-system,sans-serif}
        .case-report-view .case-header{background:linear-gradient(135deg,var(--accent-mint),var(--accent-teal));color:#081413;padding:1.5rem;border-radius:8px;margin-bottom:1.5rem}
        .case-report-view .case-header h1{margin:0;font-size:1.8rem}
        .case-report-view .case-header .case-id{font-size:1.3rem;font-weight:700;opacity:0.9}
        .case-report-view .case-header .case-date{font-size:1rem;opacity:0.8}
        .case-report-view .case-section{background:var(--bg-dark);padding:1.2rem;border-radius:6px;margin-bottom:1rem;border:1px solid rgba(255,255,255,0.05)}
        .case-report-view .case-section-title{color:var(--accent-mint);font-size:1.1rem;font-weight:700;margin:0 0 0.8rem 0;text-transform:uppercase;letter-spacing:0.5px}
        .case-report-view .case-section-content{line-height:1.7;color:var(--text-primary)}
        .case-report-view .case-subsection{margin-top:1rem}
        .case-report-view .case-subsection-title{color:var(--accent-teal);font-weight:600;margin-bottom:0.5rem}

        @media (max-width:720px){
          .cf-header{flex-direction:column;align-items:stretch}
          .cf-grid,.cf-version-grid{grid-template-columns:1fr}
          .cf-table th:nth-child(3),.cf-table td:nth-child(3){display:none}
        }
      </style>

      <div class="cf-header">
        <input id="cfSearch" class="cf-search" placeholder="Search case files by ID or subject…">
        <button id="cfNewBtn" class="cf-btn-new" style="display:none">+ New Case Report</button>
      </div>

      <table class="cf-table">
        <thead>
          <tr>
            <th>Case ID</th>
            <th>Subject</th>
            <th>Department</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="cfTableBody">
          <tr><td colspan="4" class="cf-empty">Loading…</td></tr>
        </tbody>
      </table>

      <!-- Create/Edit Modal -->
      <div id="cfModal" class="cf-modal" aria-hidden="true">
        <div class="cf-modal-content" role="dialog" aria-modal="true">
          <div class="cf-modal-header">
            <h2 id="cfModalTitle">New Case Report</h2>
            <button id="cfCloseBtn" class="cf-close" title="Close">✕</button>
          </div>

          <form id="cfForm" class="cf-form">
            <div class="cf-grid">
              <label>
                Case ID *
                <input id="cfCaseId" type="text" placeholder="IO-001" required>
                <div style="font-size:.85rem;color:var(--text-light);margin-top:.3rem">Format: IO-XXX</div>
              </label>

              <label>
                Date *
                <input id="cfDate" type="date" required>
              </label>
            </div>

            <label>
              Clearance Level *
              <select id="cfClearance" required>
                <option value="">Select…</option>
                <option value="0">Level 0 (Public)</option>
                <option value="1">Level 1</option>
                <option value="2">Level 2</option>
                <option value="3">Level 3</option>
                <option value="4">Level 4</option>
                <option value="5">Level 5 (Restricted)</option>
              </select>
            </label>

            <label>
              Subject *
              <input id="cfSubject" type="text" placeholder="Brief description of case subject" required>
            </label>

            <label>
              Content Structure (Markdown) *
              <div style="font-size:.9rem;color:var(--text-light);margin-top:.2rem">
                Use the following structure:<br>
                <code style="background:rgba(0,0,0,0.3);padding:.2rem .4rem;border-radius:3px">
                  # SUMMARY<br>
                  Brief overview...<br><br>
                  # SUBJECT<br>
                  Details...<br><br>
                  # AGENTS INVOLVED<br>
                  List of agents...<br><br>
                  # INVOLVED DEPARTMENT<br>
                  Department details...<br><br>
                  # DESCRIPTION<br>
                  ## Section Title<br>
                  Content...
                </code>
              </div>
              <div style="margin-top:.5rem;padding:.5rem;background:rgba(78,250,170,0.05);border:1px solid rgba(78,250,170,0.1);border-radius:4px">
                <strong style="color:var(--accent-mint)">Multi-Clearance System</strong>
                <p style="font-size:.85rem;color:var(--text-light);margin:.3rem 0 0 0">Create multiple versions for different clearance levels. Users see the highest version they have access to.</p>
              </div>
            </label>
            
            <div id="cfVersionsContainer"></div>
            
            <button type="button" id="cfAddVersion" class="cf-btn-secondary" style="margin-bottom:1rem">+ Add Clearance Version</button>

            <div class="cf-actions">
              <button type="submit" class="cf-btn-primary">Save Case Report</button>
              <button type="button" id="cfCancelBtn" class="cf-btn-secondary">Cancel</button>
              <button type="button" id="cfLoadBtn" class="cf-btn-secondary" style="margin-left:auto">Load Existing…</button>
            </div>
            <div id="cfStatus" class="cf-status"></div>
          </form>
        </div>
      </div>

      <!-- View Modal -->
      <div id="cfViewModal" class="cf-modal" aria-hidden="true">
        <div class="cf-modal-content" role="dialog" aria-modal="true">
          <div class="cf-modal-header">
            <h2 id="cfViewTitle">Case Report</h2>
            <button id="cfViewCloseBtn" class="cf-close" title="Close">✕</button>
          </div>
          <div id="cfViewMeta" style="color:var(--text-light);margin-bottom:1rem;font-size:.95rem"></div>
          <div id="cfViewContent" class="cf-preview case-report-view"></div>
          <div style="margin-top:1.5rem">
            <button id="cfEditBtn" class="cf-btn-primary" style="display:none">Edit</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div data-include="/components/footer.html"></div>

  <script src="/assets/js/include.js"></script>
  <script type="module" src="/assets/js/auth.js"></script>
  <script type="module">
    import { marked } from 'https://cdn.jsdelivr.net/npm/marked@12.0.2/lib/marked.esm.js';
    window.marked = marked;
  </script>
  <script type="module" src="/assets/js/caseFiles.js"></script>
</body>
</html>
