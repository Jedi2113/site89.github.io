<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Groups of Interest — RAISA — Site-89</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Roboto:wght@300;400,500&family=Roboto+Mono&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/assets/css/main.css">

  <!-- Theme System -->
  <script type="module">
    import { ThemeManager } from '/assets/js/theme.js';
    ThemeManager.init();
  </script>

  <style>
    .page-hero { padding: 2.5rem 1rem; text-align:center; background: linear-gradient(90deg, rgba(78,250,170,0.04), transparent); border-bottom: 1px solid rgba(78,250,170,0.03); }
    .page-hero .hero-title { font-family: var(--font-head); font-size: 2rem; color: var(--accent-mint); margin-bottom: 0.35rem; }
    .page-hero .hero-sub { color: var(--text-light); opacity: 0.9; }

    .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
    .header-controls h2 { color: var(--accent-mint); margin: 0; }
    .control-group { display: flex; gap: 1rem; flex-wrap: wrap; }
    
    .add-btn { padding: 0.8rem 1.5rem; background: var(--accent-mint); color: #06100e; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; }
    .add-btn:hover { background: var(--accent-teal); }
    .add-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .filter-select { padding: 0.8rem 1rem; background: var(--bg-card); border: 1px solid rgba(78,250,170,0.2); border-radius: 4px; color: var(--text-light); font-size: 0.9rem; }

    .goi-card { background: var(--bg-card); border: 2px solid rgba(78,250,170,0.15); border-radius: 8px; padding: 2rem; margin-bottom: 2rem; transition: all 0.3s ease; position: relative; }
    .goi-card:hover { border-color: var(--accent-mint); box-shadow: 0 0 20px rgba(78,250,170,0.1); }
    .goi-card.hostile { border-left: 4px solid #ff6b6b; }
    .goi-card.neutral { border-left: 4px solid #ffd700; }
    .goi-card.allied { border-left: 4px solid #4efa7c; }
    .goi-card.unknown { border-left: 4px solid #888; }
    
    .goi-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap; }
    .goi-title { font-size: 1.8rem; font-weight: 700; color: var(--accent-mint); margin: 0; }
    .goi-designation { font-family: var(--font-mono); color: var(--accent-teal); font-size: 0.95rem; margin: 0.3rem 0; }
    
    .goi-meta { display: flex; gap: 1rem; margin: 1rem 0; flex-wrap: wrap; }
    .meta-tag { padding: 0.4rem 0.8rem; background: rgba(78,250,170,0.1); border-radius: 4px; font-size: 0.85rem; color: var(--accent-teal); font-weight: 600; }
    .threat-level { padding: 0.4rem 0.8rem; border-radius: 4px; font-size: 0.85rem; font-weight: 700; }
    .threat-high { background: rgba(255,107,107,0.2); color: #ff6b6b; }
    .threat-medium { background: rgba(255,215,0,0.2); color: #ffd700; }
    .threat-low { background: rgba(78,250,170,0.2); color: var(--accent-mint); }
    .threat-unknown { background: rgba(136,136,136,0.2); color: #888; }
    
    .goi-description { color: var(--text-light); line-height: 1.8; margin: 1rem 0; }
    .goi-section { margin: 1.5rem 0; }
    .goi-section h4 { color: var(--accent-teal); margin: 0 0 0.8rem 0; font-size: 1.1rem; }
    .goi-section p { color: var(--text-light); line-height: 1.6; }
    .goi-section ul { margin: 0.5rem 0; padding-left: 2rem; }
    .goi-section li { margin-bottom: 0.4rem; color: var(--text-light); }

    .goi-actions { display: flex; gap: 0.8rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(78,250,170,0.1); }
    .action-btn { padding: 0.5rem 1rem; background: rgba(78,250,170,0.1); border: 1px solid var(--accent-mint); color: var(--accent-mint); border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s ease; }
    .action-btn:hover { background: var(--accent-mint); color: #06100e; }
    .action-btn.delete { border-color: #ff6b6b; color: #ff6b6b; }
    .action-btn.delete:hover { background: #ff6b6b; color: white; }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-box { background: var(--bg-card); border: 2px solid var(--accent-mint); border-radius: 8px; padding: 2rem; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-box h2 { color: var(--accent-mint); margin: 0 0 1.5rem 0; }
    .modal-box label { display: block; color: var(--accent-teal); font-weight: 600; margin: 1rem 0 0.5rem 0; }
    .modal-box input, .modal-box textarea, .modal-box select { width: 100%; padding: 0.8rem; background: var(--bg-soft); border: 1px solid rgba(78,250,170,0.2); border-radius: 4px; color: var(--text-light); font-family: var(--font-body); box-sizing: border-box; }
    .modal-box textarea { min-height: 150px; font-family: var(--font-body); resize: vertical; }
    .modal-box input:focus, .modal-box textarea:focus, .modal-box select:focus { outline: none; border-color: var(--accent-mint); }
    .modal-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; }
    .modal-buttons button { flex: 1; padding: 0.8rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
    .btn-save { background: var(--accent-mint); color: #06100e; }
    .btn-cancel { background: rgba(78,250,170,0.1); border: 1px solid var(--accent-mint); color: var(--accent-mint); }

    .no-gois { text-align: center; padding: 3rem; color: var(--text-light); opacity: 0.8; }
    .access-notice { background: rgba(78,250,170,0.05); border: 1px solid rgba(78,250,170,0.2); border-radius: 6px; padding: 1rem; margin-bottom: 2rem; color: var(--text-light); }
    .access-notice i { color: var(--accent-mint); margin-right: 0.5rem; }

    @media (max-width: 768px) {
      .goi-header { flex-direction: column; }
      .header-controls { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <div data-include="/components/header.html"></div>
  <div data-include="/components/navbar.html"></div>

  <section class="page-hero">
    <div class="hero-title">Groups of Interest (GOI)</div>
    <div class="hero-sub">External organizations, factions, and entities monitored by RAISA Intelligence</div>
  </section>

  <section class="content">
    <div class="header-controls">
      <h2>GOI Database</h2>
      <div class="control-group">
        <select id="filterThreat" class="filter-select">
          <option value="all">All Threat Levels</option>
          <option value="High">High Threat</option>
          <option value="Medium">Medium Threat</option>
          <option value="Low">Low Threat</option>
          <option value="Unknown">Unknown</option>
        </select>
        <select id="filterStance" class="filter-select">
          <option value="all">All Stances</option>
          <option value="Hostile">Hostile</option>
          <option value="Neutral">Neutral</option>
          <option value="Allied">Allied</option>
          <option value="Unknown">Unknown</option>
        </select>
        <button id="addGoiBtn" class="add-btn" style="display:none;">
          <i class="fas fa-plus"></i> Add GOI
        </button>
      </div>
    </div>

    <div id="accessNotice" class="access-notice" style="display:none;">
      <i class="fas fa-info-circle"></i>
      <strong>For RAISA Personnel & Level 5+:</strong> You have permission to create and manage Groups of Interest entries.
    </div>

    <div id="goisContainer">
      <div class="no-gois">
        <i class="fas fa-users" style="font-size:3rem;opacity:0.3;margin-bottom:1rem;"></i>
        <p>No Groups of Interest on record.</p>
      </div>
    </div>
  </section>

  <!-- Add/Edit GOI Modal -->
  <div id="goiModal" class="modal">
    <div class="modal-box">
      <h2 id="modalTitle">New Group of Interest</h2>
      
      <label for="goiName">Name *</label>
      <input type="text" id="goiName" placeholder="e.g., Chaos Insurgency">
      
      <label for="goiDesignation">Official Designation</label>
      <input type="text" id="goiDesignation" placeholder="e.g., GOI-001">
      
      <label for="goiThreat">Threat Level *</label>
      <select id="goiThreat">
        <option value="">-- Select Threat Level --</option>
        <option value="High">High</option>
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
        <option value="Unknown">Unknown</option>
      </select>
      
      <label for="goiStance">Stance Towards Foundation *</label>
      <select id="goiStance">
        <option value="">-- Select Stance --</option>
        <option value="Hostile">Hostile</option>
        <option value="Neutral">Neutral</option>
        <option value="Allied">Allied</option>
        <option value="Unknown">Unknown</option>
      </select>
      
      <label for="goiDescription">Description *</label>
      <textarea id="goiDescription" placeholder="Brief overview of the group"></textarea>
      
      <label for="goiActivities">Known Activities</label>
      <textarea id="goiActivities" placeholder="List of known activities and operations"></textarea>
      
      <label for="goiCapabilities">Capabilities & Resources</label>
      <textarea id="goiCapabilities" placeholder="Known capabilities, assets, and resources"></textarea>
      
      <label for="goiNotes">Additional Notes</label>
      <textarea id="goiNotes" placeholder="Intelligence notes, observations, or updates"></textarea>
      
      <div class="modal-buttons">
        <button class="btn-save" onclick="saveGoi()">Save GOI Entry</button>
        <button class="btn-cancel" onclick="closeGoiModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div data-include="/components/footer.html"></div>
  <script src="/assets/js/include.js"></script>
  <script type="module">
    import { app, auth } from "/assets/js/auth.js";
    import { getFirestore, collection, query, getDocs, addDoc, doc, updateDoc, deleteDoc, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    const db = getFirestore(app);
    let currentUser = null;
    let userCharacter = null;
    let canManageGois = false;
    let editingGoiId = null;

    // Check user permissions
    async function checkPermissions() {
      try {
        const raw = localStorage.getItem('selectedCharacter');
        if (!raw) return false;
        
        userCharacter = JSON.parse(raw);
        const dept = userCharacter.department || '';
        const rank = userCharacter.rank || '';
        const clearance = userCharacter.clearance || 0;
        
        // Allow RAISA members OR Level 5+ personnel to manage GOIs
        canManageGois = dept.includes('RAISA') || clearance >= 5;
        
        if (canManageGois) {
          document.getElementById('addGoiBtn').style.display = 'inline-block';
          document.getElementById('accessNotice').style.display = 'block';
        }
        
        return canManageGois;
      } catch (err) {
        console.error('Error checking permissions:', err);
        return false;
      }
    }

    // Load all GOIs
    async function loadGois(filterThreat = 'all', filterStance = 'all') {
      try {
        let goisQuery = query(collection(db, 'groups-of-interest'), orderBy('name', 'asc'));
        const snapshot = await getDocs(goisQuery);
        
        const container = document.getElementById('goisContainer');
        
        if (snapshot.empty) {
          container.innerHTML = `
            <div class="no-gois">
              <i class="fas fa-users" style="font-size:3rem;opacity:0.3;margin-bottom:1rem;"></i>
              <p>No Groups of Interest on record.</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = '';
        let visibleCount = 0;
        
        snapshot.forEach(docSnap => {
          const goi = docSnap.data();
          const goiId = docSnap.id;
          
          // Apply filters
          if (filterThreat !== 'all' && goi.threatLevel !== filterThreat) return;
          if (filterStance !== 'all' && goi.stance !== filterStance) return;
          
          visibleCount++;
          
          const stanceClass = (goi.stance || 'unknown').toLowerCase();
          const threatClass = `threat-${(goi.threatLevel || 'unknown').toLowerCase()}`;
          
          const actionButtons = canManageGois ? `
            <div class="goi-actions">
              <button class="action-btn" onclick="editGoi('${goiId}')">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="action-btn delete" onclick="deleteGoi('${goiId}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          ` : '';
          
          const goiHTML = `
            <div class="goi-card ${stanceClass}">
              <div class="goi-header">
                <div>
                  <h3 class="goi-title">${goi.name || 'Unknown Group'}</h3>
                  ${goi.designation ? `<div class="goi-designation">${goi.designation}</div>` : ''}
                </div>
              </div>
              <div class="goi-meta">
                <span class="threat-level ${threatClass}">Threat: ${goi.threatLevel || 'Unknown'}</span>
                <span class="meta-tag">Stance: ${goi.stance || 'Unknown'}</span>
              </div>
              <div class="goi-description">${goi.description || 'No description available.'}</div>
              ${goi.activities ? `
                <div class="goi-section">
                  <h4>Known Activities</h4>
                  <p>${goi.activities}</p>
                </div>
              ` : ''}
              ${goi.capabilities ? `
                <div class="goi-section">
                  <h4>Capabilities & Resources</h4>
                  <p>${goi.capabilities}</p>
                </div>
              ` : ''}
              ${goi.notes ? `
                <div class="goi-section">
                  <h4>Intelligence Notes</h4>
                  <p>${goi.notes}</p>
                </div>
              ` : ''}
              ${actionButtons}
            </div>
          `;
          
          container.innerHTML += goiHTML;
        });
        
        if (visibleCount === 0) {
          container.innerHTML = `
            <div class="no-gois">
              <i class="fas fa-filter" style="font-size:3rem;opacity:0.3;margin-bottom:1rem;"></i>
              <p>No Groups of Interest match the selected filters.</p>
            </div>
          `;
        }
      } catch (err) {
        console.error('Error loading GOIs:', err);
      }
    }

    // Modal functions
    window.openGoiModal = function() {
      editingGoiId = null;
      document.getElementById('modalTitle').textContent = 'New Group of Interest';
      document.getElementById('goiName').value = '';
      document.getElementById('goiDesignation').value = '';
      document.getElementById('goiThreat').value = '';
      document.getElementById('goiStance').value = '';
      document.getElementById('goiDescription').value = '';
      document.getElementById('goiActivities').value = '';
      document.getElementById('goiCapabilities').value = '';
      document.getElementById('goiNotes').value = '';
      document.getElementById('goiModal').classList.add('active');
    };

    window.closeGoiModal = function() {
      document.getElementById('goiModal').classList.remove('active');
      editingGoiId = null;
    };

    window.saveGoi = async function() {
      const name = document.getElementById('goiName').value.trim();
      const designation = document.getElementById('goiDesignation').value.trim();
      const threatLevel = document.getElementById('goiThreat').value;
      const stance = document.getElementById('goiStance').value;
      const description = document.getElementById('goiDescription').value.trim();
      const activities = document.getElementById('goiActivities').value.trim();
      const capabilities = document.getElementById('goiCapabilities').value.trim();
      const notes = document.getElementById('goiNotes').value.trim();
      
      if (!name || !threatLevel || !stance || !description) {
        alert('Please fill in all required fields (Name, Threat Level, Stance, Description)');
        return;
      }
      
      try {
        const goiData = {
          name: name,
          designation: designation,
          threatLevel: threatLevel,
          stance: stance,
          description: description,
          activities: activities,
          capabilities: capabilities,
          notes: notes,
          lastUpdatedBy: userCharacter.name || 'Unknown',
          lastUpdatedById: currentUser.uid,
          updatedAt: serverTimestamp()
        };
        
        if (editingGoiId) {
          await updateDoc(doc(db, 'groups-of-interest', editingGoiId), goiData);
        } else {
          goiData.createdAt = serverTimestamp();
          goiData.createdBy = userCharacter.name || 'Unknown';
          await addDoc(collection(db, 'groups-of-interest'), goiData);
        }
        
        closeGoiModal();
        loadGois();
      } catch (err) {
        alert('Error saving GOI: ' + err.message);
        console.error(err);
      }
    };

    window.editGoi = async function(goiId) {
      try {
        const goiDoc = doc(db, 'groups-of-interest', goiId);
        const snapshot = await getDocs(query(collection(db, 'groups-of-interest'), where('__name__', '==', goiId)));
        
        if (snapshot.empty) {
          alert('GOI not found');
          return;
        }
        
        const goi = snapshot.docs[0].data();
        editingGoiId = goiId;
        
        document.getElementById('modalTitle').textContent = 'Edit Group of Interest';
        document.getElementById('goiName').value = goi.name || '';
        document.getElementById('goiDesignation').value = goi.designation || '';
        document.getElementById('goiThreat').value = goi.threatLevel || '';
        document.getElementById('goiStance').value = goi.stance || '';
        document.getElementById('goiDescription').value = goi.description || '';
        document.getElementById('goiActivities').value = goi.activities || '';
        document.getElementById('goiCapabilities').value = goi.capabilities || '';
        document.getElementById('goiNotes').value = goi.notes || '';
        document.getElementById('goiModal').classList.add('active');
      } catch (err) {
        alert('Error loading GOI: ' + err.message);
        console.error(err);
      }
    };

    window.deleteGoi = async function(goiId) {
      if (!confirm('Are you sure you want to delete this Group of Interest? This action cannot be undone.')) {
        return;
      }
      
      try {
        await deleteDoc(doc(db, 'groups-of-interest', goiId));
        loadGois();
      } catch (err) {
        alert('Error deleting GOI: ' + err.message);
        console.error(err);
      }
    };

    // Wire up event listeners
    document.getElementById('addGoiBtn').addEventListener('click', openGoiModal);
    document.getElementById('filterThreat').addEventListener('change', (e) => {
      const threat = e.target.value;
      const stance = document.getElementById('filterStance').value;
      loadGois(threat, stance);
    });
    document.getElementById('filterStance').addEventListener('change', (e) => {
      const stance = e.target.value;
      const threat = document.getElementById('filterThreat').value;
      loadGois(threat, stance);
    });

    // Initialize
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        await checkPermissions();
      }
      loadGois();
    });
  </script>
</body>
</html>
